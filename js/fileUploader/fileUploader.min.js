var upLoader=angular.module("imageUploade",[]);upLoader.constant("html5",!!(window.File&&window.FormData));upLoader.value("errors",{100:"Не подходящий формат файла!",110:"При загрузке файла произошла ошибка!",120:"Привышен лимит на загрузку фалов!"});upLoader.value("dropElement",null);upLoader.directive("imageThumb",["$imageUploade","html5",function(b,a){return{link:function(l,f,j){var g=l.$eval(j.imageThumb),e=j.width||100,c=j.height||100,h=0,d=0;f[0].style.cssText+="width:"+e+"px; height: "+c+"px; overflow: hidden";var k=function(o){var n=new Image(),p=0,m=0;n.src=o;n.onerror=function(){throw ("Не создать превью картинки!")};n.onload=function(){p=this.width;m=this.height;if(p<e&&m<c){h=p;d=m}if(p/e>m/c){h=e;d=Math.round(m*e/p)}else{d=c;h=Math.round(p*c/m)}n.width=h;n.height=d;f.append(n)}};if(a){var i=new FileReader();i.readAsDataURL(g);i.onloadend=function(m){var n=m;k(n.target.result)}}}}}]);upLoader.directive("dropZone",["$imageUploade","html5","$timeout",function(c,a,b){return{scope:{result:"=?",settings:"=?"},link:function(e,f,d){b(function(){if(e.result){e=e.result.scope}else{if(e.settings){e.settings.scope=e}else{e.settings={scope:e}}c.create(e.settings)}f.unbind("drop dragover dragleave");f.bind("drop",function(h){var g=h.dataTransfer?h.dataTransfer:h.originalEvent.dataTransfer;e.$emit("add:uplode",g.files);f.removeClass("active");h.stopPropagation();h.preventDefault()}).bind("dragover",function(h){var g=h.dataTransfer?h.dataTransfer:h.originalEvent.dataTransfer;f.addClass("active");g.dropEffect="copy";h.stopPropagation();h.preventDefault()}).bind("dragleave",function(g){f.removeClass("active");g.stopPropagation();g.preventDefault()})},0)}}}]);upLoader.directive("dragSort",["$imageUploade","html5","dropElement",function(c,b,a){return{link:function(e,g,d){var f=e.$eval(d.dragSort);g.prop("draggable",true);g.unbind("dragstart selectstart drop dragover dragleave dragend");g.bind("dragstart",function(i){var h=h=i.dataTransfer?i.dataTransfer:i.originalEvent.dataTransfer;a=this;this.style.opacity=0.4;h.effectAllowed="move";h.setData("Text",this.innerHTML)}).bind("selectstart",function(h){this.dragDrop();h.preventDefault()}).bind("drop",function(i){var h=h=i.dataTransfer?i.dataTransfer:i.originalEvent.dataTransfer;if(a){f.scope.$emit("sort:uplode",this.id,a.id);a.style.opacity=1;angular.element(this).removeClass("over")}else{return false}i.stopPropagation()}).bind("dragover",function(i){var h=h=i.dataTransfer?i.dataTransfer:i.originalEvent.dataTransfer;h.dropEffect="move";angular.element(this).addClass("over");i.preventDefault();i.stopPropagation()}).bind("dragleave",function(h){angular.element(this).removeClass("over");h.preventDefault();h.stopPropagation()}).bind("dragend",function(h){this.style.opacity=1;h.preventDefault()})}}}]);upLoader.directive("uploadeSource",["$imageUploade","html5",function(b,a){return{scope:{settings:"=?",result:"=?"},restrict:"A",link:function(d,e,c){d.$watch("settings",function(f){if(f!==undefined){if(d.settings){d.settings.scope=d}else{d.settings={scope:d}}b.create(d.settings);if(a){if(d.settings.multiple||d.settings.multiple===undefined){e.prop("multiple",true)}}else{if(c.uploadeSource==="flash"){e.css("display","none");d.$emit("flash:uplode",e)}}e.unbind("change");e.bind("change",function(){d.$emit("add:uplode",a?this.files:this)})}})}}}]);upLoader.factory("$imageUploade",["html5","$rootScope","errors","$compile","$timeout","$interval",function(b,a,h,e,d,f){var g=function(i){if(!(this instanceof g)){return new g(i)}angular.extend(this,{isHtml5:b,root:a,scope:null,multiple:true,acceptTypes:[],file_upload_limit:0,errorQueue:[],swfUploadOptions:{},allUploded:0,queue:[],errors:[],timestamp:Date.now()},i);this.scope.result=this;this.scope.$on("add:uplode",function(m,l){m.stopPropagation();if(l.outerHTML){l.transport="iframe"}else{l.transport="html5"}var k=l.length?l:[l];if(this.file_upload_limit===0){this.addFilesToQueue(l)}else{if(this.queue.length<this.file_upload_limit&&k.length<=this.file_upload_limit&&l.length!==0){this.addFilesToQueue(l)}else{this.errors.push(h[120]);this.updateScope()}}}.bind(this));this.scope.$on("flash:uplode",function(l,k){this.SWFinit(k)}.bind(this));this.scope.$on("sort:uplode",function(m,l,k){console.log("sort");this.reSort(l,k)}.bind(this));var j=this};g.prototype={reSort:function(p,o){var n=this.queue.length,m=null,l=null,j=[],k=0;do{var q=this.queue[k];if(q.unicid===p){m=k}if(q.unicid===o){l=k}k++}while(k<n);k=0;do{if(k===m){j[k]=this.queue[l]}else{if(k===l){j[k]=this.queue[m]}else{j.push(this.queue[k])}}k++}while(k<n);this.queue=j;this.scope.result.queue=j;this.trigger("afterSort",this.queue[m],this.queue[l],this.queue);this.updateScope()},generateQuickGuid:function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},addFilesToQueue:function(j){var n=j.length,l=0,k=n?j:[j];do{var m=new c(k[l],{uplode:this,scope:this.scope,file:k[l]},j.transport);if(!m.error){this.queue.push(m)}else{this.errorQueue.push(m)}l++}while(l<n);this.loadedAll();this.updateScope()},updateScope:function(){this.root.$$phase||this.root.$digest()},bind:function(j,i){this.scope.$on(this.timestamp+":"+j,i.bind(this))},trigger:function(i,j){arguments[0]=this.timestamp+":"+i;this.scope.$broadcast.apply(this.scope,arguments)},loadedAll:function(){var j=this.queue.length;var i=function(k){k=k||0;if(k<j){if(!this.queue[k].isUploaded){switch(this.queue[k].transport){case"html5":this.xhrUplode(this.queue[k],function(){k++;i(k)});break;case"iframe":this.iframeUplode(this.queue[k]);break}}else{k++;i(k)}}}.bind(this);i()},xhrUplode:function(k,m){var l=new XMLHttpRequest(),j=new FormData(),i=this;k.xhr=l;i.trigger("beforeUplode",k,this);j.append("Filedata",k.file);if(this.post_params){angular.forEach(this.post_params,function(o,n){j.append(n,o)})}l.upload.onprogress=function(o){var n=o.lengthComputable?o.loaded*100/o.total:0;k.progress=n;i.updateScope()};l.onload=function(){if(this.readyState===4&&this.status===200){k.afterUploade(this.response);m()}};l.onabort=function(){};l.onerror=function(){k.error=h[110];i.errorQueue.push(k)};l.open("POST",this.url,true);l.send(j)},iframeUplode:function(l){var i=angular.element(l.file.input),m=e(i.clone())(this.scope),j=angular.element('<iframe name="iframeTransport'+Date.now()+'">'),k=angular.element('<form style="display: none;" />');k.prop({enctype:"multipart/form-data",target:j.prop("name"),action:this.url,method:"POST"});m.prop("value",null);i.prop("name","Filedata");i.css("display","none").after(m).after(k);k.append(i).append(j);if(this.post_params){angular.forEach(this.post_params,function(o,n){k.append(angular.element("<input type='hidden' name='"+n+"' value='"+o+"'>"))})}k[0].submit();angular.element(j).bind("load",function(){l.afterUploade(this.response);k.replaceWith("")})},SWFinit:function(l){var k=this;if(SWFUpload){var m=this.swfUploadOptions.button_placeholder_id||"flash";angular.extend(this.swfUploadOptions,{file_upload_limit:this.file_upload_limit,upload_url:this.url,post_params:this.post_params});var i=angular.extend([],k.acceptTypes),j=i.length;while(j--){i[j]="*."+i[j]+";*."+i[j].toUpperCase()}this.swfUploadOptions.file_types=i.join(";");l.after(angular.element('<div id="'+m+'"></div>'));this.swfUploadOptions.file_queued_handler=function(n){n.transport="flash";k.addFilesToQueue(n)};this.swfUploadOptions.upload_success_handler=function(o,n){angular.forEach(k.queue,function(p){if(p.file.flash.index===o.index){p.afterUploade(n)}})};this.swfUploadOptions.file_queue_error_handler=function(n,p,o){k.scope.$apply(function(){switch(p){case -100:k.errors.push(h[120]);break}})};this.swfUploadOptions.file_dialog_complete_handler=function(n,o){this.startUpload()};this.flash=new SWFUpload(this.swfUploadOptions)}}};var c=function(l,j,k){switch(k){case"iframe":var m=l.value,i=m.slice(m.lastIndexOf("\\")+1),k=m.slice(m.lastIndexOf(".")+1).toLowerCase();j.file={lastModifiedDate:new Date(),name:i,size:0,type:"image/"+k,input:l};j.transport="iframe";break;case"flash":j.file={lastModifiedDate:l.modificationdate,name:l.name,size:l.size,type:"image/"+l.type.slice(l.type.lastIndexOf(".")+1).toLowerCase(),flash:l};j.transport="flash";break}var k=j.file.type.slice(j.file.type.lastIndexOf("/")+1);if(j.uplode.acceptTypes.indexOf(k)===-1||!k){j.error=h[100]}angular.extend(this,{unicid:j.uplode.generateQuickGuid(),transport:"html5",isUploaded:false,error:false,mbSize:(j.file.size/(1000*1024)).toFixed(2),progress:0},j);return this};c.prototype={afterUploade:function(i){this.isUploaded=true;this.scope.result.allUploded++;this.uplode.trigger("uplodeItemComplite",this,i);this.uplode.updateScope()},remove:function(){var i=this.uplode.queue.indexOf(this);this.uplode.queue.splice(i,1);this.uplode.trigger("uplodeItemRemove",this);this.scope.result.allUploded--}};return{create:function(i){return g(i)},getInstance:function(j,i,l){var k=f(function(){var m=j[i];if(m){f.cancel(k);l(m)}},100)}}}]);
var upLoader=angular.module("imageUploade",[]);upLoader.constant("html5",!!(window.File&&window.FormData));upLoader.value("errors",{100:"Не подходящий формат файла!",110:"При загрузке файла произошла ошибка!",120:"Привышен лимит на загрузку фалов!"});upLoader.directive("uploadeSource",["$imageUploade","html5",function(b,a){return{scope:{settings:"=?",result:"=?"},restrict:"A",link:function(d,e,c){if(d.settings){d.settings.scope=d}else{d.settings={scope:d}}b.create(d.settings);if(a){if(d.settings.multiple||d.settings.multiple===undefined){e.prop("multiple",true)}}else{if(c.uploadeSource==="flash"){e.css("display","none");d.$emit("flash:uplode",e)}}e.bind("change",function(){d.$emit("add:uplode",a?this.files:this)})}}}]);upLoader.factory("$imageUploade",["html5","$rootScope","errors","$compile","$timeout",function(b,a,g,e,d){var f=function(h){if(!(this instanceof f)){return new f(h)}angular.extend(this,{isHtml5:b,root:a,scope:null,multiple:true,acceptTypes:[],file_upload_limit:0,errorQueue:[],swfUploadOptions:{},allUploded:0,queue:[],errors:[],timestamp:Date.now()},h);this.scope.result=this;this.scope.$on("add:uplode",function(l,k){l.stopPropagation();if(k.outerHTML){k.transport="iframe"}else{k.transport="html5"}var j=k.length?k:[k];if(this.file_upload_limit===0){this.addFilesToQueue(k)}else{if(this.queue.length<this.file_upload_limit&&j.length<=this.file_upload_limit&&k.length!==0){this.addFilesToQueue(k)}else{this.errors.push(g[120]);this.updateScope()}}}.bind(this));this.scope.$on("flash:uplode",function(k,j){this.SWFinit(j)}.bind(this));this.scope.$on("sort:uplode",function(l,k,j){console.log("sort");this.reSort(k,j)}.bind(this));var i=this};f.prototype={reSort:function(o,n){var m=this.queue.length,l=null,k=null,h=[],j=0;do{var p=this.queue[j];if(p.unicid===o){l=j}if(p.unicid===n){k=j}j++}while(j<m);j=0;do{if(j===l){h[j]=this.queue[k]}else{if(j===k){h[j]=this.queue[l]}else{h.push(this.queue[j])}}j++}while(j<m);this.queue=h;this.scope.result.queue=h;this.trigger("afterSort",this.queue[l],this.queue[k],this.queue);this.updateScope()},generateQuickGuid:function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},addFilesToQueue:function(h){var m=h.length,k=0,j=m?h:[h];do{var l=new c(j[k],{uplode:this,scope:this.scope,file:j[k]},h.transport);if(!l.error){this.queue.push(l)}else{this.errorQueue.push(l)}k++}while(k<m);this.loadedAll();this.updateScope()},updateScope:function(){this.root.$$phase||this.root.$digest()},bind:function(i,h){this.scope.$on(this.timestamp+":"+i,h.bind(this))},trigger:function(h,i){arguments[0]=this.timestamp+":"+h;this.scope.$broadcast.apply(this.scope,arguments)},loadedAll:function(){var i=this.queue.length;var h=function(j){j=j||0;if(j<i){if(!this.queue[j].isUploaded){switch(this.queue[j].transport){case"html5":this.xhrUplode(this.queue[j],function(){j++;h(j)});break;case"iframe":this.iframeUplode(this.queue[j]);break}}else{j++;h(j)}}}.bind(this);h()},xhrUplode:function(j,l){var k=new XMLHttpRequest(),i=new FormData(),h=this;j.xhr=k;h.trigger("beforeUplode",j,this);i.append("Filedata",j.file);if(this.post_params){angular.forEach(this.post_params,function(n,m){i.append(m,n)})}k.upload.onprogress=function(n){var m=n.lengthComputable?n.loaded*100/n.total:0;j.progress=m;h.updateScope()};k.onload=function(){if(this.readyState===4&&this.status===200){j.afterUploade(this.response);l()}};k.onabort=function(){};k.onerror=function(){j.error=g[110];h.errorQueue.push(j)};k.open("POST",this.url,true);k.send(i)},iframeUplode:function(k){var h=angular.element(k.file.input),l=e(h.clone())(this.scope),i=angular.element('<iframe name="iframeTransport'+Date.now()+'">'),j=angular.element('<form style="display: none;" />');j.prop({enctype:"multipart/form-data",target:i.prop("name"),action:this.url,method:"POST"});l.prop("value",null);h.prop("name","Filedata");h.css("display","none").after(l).after(j);j.append(h).append(i);if(this.post_params){angular.forEach(this.post_params,function(n,m){j.append(angular.element("<input type='hidden' name='"+m+"' value='"+n+"'>"))})}j[0].submit();angular.element(i).bind("load",function(){k.afterUploade(this.response);j.replaceWith("")})},SWFinit:function(k){var j=this;if(SWFUpload){var l=this.swfUploadOptions.button_placeholder_id||"flash";angular.extend(this.swfUploadOptions,{file_upload_limit:this.file_upload_limit,upload_url:this.url,post_params:this.post_params});var h=angular.extend([],j.acceptTypes),i=h.length;while(i--){h[i]="*."+h[i]+";*."+h[i].toUpperCase()}this.swfUploadOptions.file_types=h.join(";");k.after(angular.element('<div id="'+l+'"></div>'));this.swfUploadOptions.file_queued_handler=function(m){m.transport="flash";j.addFilesToQueue(m)};this.swfUploadOptions.upload_success_handler=function(n,m){angular.forEach(j.queue,function(o){if(o.file.flash.index===n.index){o.afterUploade(m)}})};this.swfUploadOptions.file_queue_error_handler=function(m,o,n){j.scope.$apply(function(){switch(o){case -100:j.errors.push(g[120]);break}})};this.swfUploadOptions.file_dialog_complete_handler=function(m,n){this.startUpload()};this.flash=new SWFUpload(this.swfUploadOptions)}}};var c=function(k,i,j){switch(j){case"iframe":var l=k.value,h=l.slice(l.lastIndexOf("\\")+1),j=l.slice(l.lastIndexOf(".")+1).toLowerCase();i.file={lastModifiedDate:new Date(),name:h,size:0,type:"image/"+j,input:k};i.transport="iframe";break;case"flash":i.file={lastModifiedDate:k.modificationdate,name:k.name,size:k.size,type:"image/"+k.type.slice(k.type.lastIndexOf(".")+1).toLowerCase(),flash:k};i.transport="flash";break}var j=i.file.type.slice(i.file.type.lastIndexOf("/")+1);if(i.uplode.acceptTypes.indexOf(j)===-1||!j){i.error=g[100]}angular.extend(this,{unicid:i.uplode.generateQuickGuid(),transport:"html5",isUploaded:false,error:false,mbSize:(i.file.size/(1000*1024)).toFixed(2),progress:0},i);return this};c.prototype={afterUploade:function(h){this.isUploaded=true;this.scope.result.allUploded++;this.uplode.trigger("uplodeItemComplite",this,h);this.uplode.updateScope()},remove:function(){var h=this.uplode.queue.indexOf(this);this.uplode.queue.splice(h,1);this.uplode.trigger("uplodeItemRemove",this);this.scope.result.allUploded--}};return{create:function(h){return f(h)},getInstance:function(i,h,j){d(function(){j(i[h])},0)}}}]);
var upLoader=angular.module("imageUploade",[]);upLoader.constant("html5",!!(window.File&&window.FormData));upLoader.value("errors",{100:"Не подходящий формат файла!",110:"При загрузке файла произошла ошибка!",120:"Привышен лимит на загрузку фалов!"});upLoader.value("dropElement",null);upLoader.directive("imageThumb",["$imageUploade","html5",function(c,d){return{link:function(a,q,m){var p=a.$eval(m.imageThumb),r=m.width||100,t=m.height||100,o=0,s=0;q[0].style.cssText+="width:"+r+"px; height: "+t+"px; overflow: hidden";var b=function(g){var h=new Image(),f=0,e=0;h.src=g;h.onerror=function(){throw ("Не создать превью картинки!")};h.onload=function(){f=this.width;e=this.height;if(f<r&&e<t){o=f;s=e}if(f/r>e/t){o=r;s=Math.round(e*r/f)}else{s=t;o=Math.round(f*t/e)}h.width=o;h.height=s;q.append(h)}};if(d){var n=new FileReader();n.readAsDataURL(p);n.onloadend=function(e){var f=e;b(f.target.result)}}}}}]);upLoader.directive("dropZone",["$imageUploade","html5","$timeout",function(f,e,d){return{scope:{result:"=?",settings:"=?"},link:function(b,a,c){d(function(){if(b.result){b=b.result.scope}else{if(b.settings){b.settings.scope=b}else{b.settings={scope:b}}f.create(b.settings)}a.unbind("drop dragover dragleave");a.bind("drop",function(i){var j=i.dataTransfer?i.dataTransfer:i.originalEvent.dataTransfer;b.$emit("add:uplode",j.files);a.removeClass("active");i.stopPropagation();i.preventDefault()}).bind("dragover",function(i){var j=i.dataTransfer?i.dataTransfer:i.originalEvent.dataTransfer;a.addClass("active");j.dropEffect="copy";i.stopPropagation();i.preventDefault()}).bind("dragleave",function(h){a.removeClass("active");h.stopPropagation();h.preventDefault()})},0)}}}]);upLoader.directive("dragSort",["$imageUploade","html5","dropElement",function(f,d,e){return{link:function(c,a,h){var b=c.$eval(h.dragSort);a.prop("draggable",true);a.unbind("dragstart selectstart drop dragover dragleave dragend");a.bind("dragstart",function(g){var j=j=g.dataTransfer?g.dataTransfer:g.originalEvent.dataTransfer;e=this;this.style.opacity=0.4;j.effectAllowed="move";j.setData("Text",this.innerHTML)}).bind("selectstart",function(g){this.dragDrop();g.preventDefault()}).bind("drop",function(g){var j=j=g.dataTransfer?g.dataTransfer:g.originalEvent.dataTransfer;if(e){b.scope.$emit("sort:uplode",this.id,e.id);e.style.opacity=1;angular.element(this).removeClass("over")}else{return false}g.stopPropagation()}).bind("dragover",function(g){var j=j=g.dataTransfer?g.dataTransfer:g.originalEvent.dataTransfer;j.dropEffect="move";angular.element(this).addClass("over");g.preventDefault();g.stopPropagation()}).bind("dragleave",function(g){angular.element(this).removeClass("over");g.preventDefault();g.stopPropagation()}).bind("dragend",function(g){this.style.opacity=1;g.preventDefault()})}}}]);upLoader.directive("uploadeSource",["$imageUploade","html5",function(c,d){return{scope:{settings:"=?",result:"=?"},restrict:"A",link:function(b,a,f){b.$watch("settings",function(e){if(e!==undefined){if(b.settings){b.settings.scope=b}else{b.settings={scope:b}}c.create(b.settings);if(d){if(b.settings.multiple||b.settings.multiple===undefined){a.prop("multiple",true)}}else{if(f.uploadeSource==="flash"){a.css("display","none");b.$emit("flash:uplode",a)}}a.unbind("change");a.bind("change",function(){b.$emit("add:uplode",d?this.files:this)})}})}}}]);upLoader.factory("$imageUploade",["html5","$rootScope","errors","$compile","$timeout","$interval",function(i,j,k,n,o,m){var l=function(b){if(!(this instanceof l)){return new l(b)}angular.extend(this,{isHtml5:i,root:j,scope:null,multiple:true,acceptTypes:[],file_upload_limit:0,errorQueue:[],swfUploadOptions:{},allUploded:0,queue:[],errors:[],timestamp:Date.now()},b);this.scope.result=this;this.scope.$on("add:uplode",function(c,d){c.stopPropagation();if(d.outerHTML){d.transport="iframe"}else{d.transport="html5"}var e=d.length?d:[d];if(this.file_upload_limit===0){this.addFilesToQueue(d)}else{if(this.queue.length<this.file_upload_limit&&e.length<=this.file_upload_limit&&d.length!==0){this.addFilesToQueue(d)}else{this.errors.push(k[120]);this.updateScope()}}}.bind(this));this.scope.$on("flash:uplode",function(c,d){this.SWFinit(d)}.bind(this));this.scope.$on("sort:uplode",function(c,d,e){console.log("sort");this.reSort(d,e)}.bind(this));var a=this};l.prototype={reSort:function(f,g){var h=this.queue.length,a=null,b=null,d=[],c=0;do{var e=this.queue[c];if(e.unicid===f){a=c}if(e.unicid===g){b=c}c++}while(c<h);c=0;do{if(c===a){d[c]=this.queue[b]}else{if(c===b){d[c]=this.queue[a]}else{d.push(this.queue[c])}}c++}while(c<h);this.queue=d;this.scope.result.queue=d;this.trigger("afterSort",this.queue[a],this.queue[b],this.queue);this.updateScope()},generateQuickGuid:function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},addFilesToQueue:function(d){var e=d.length,b=0,c=e?d:[d];do{var a=new p(c[b],{uplode:this,scope:this.scope,file:c[b]},d.transport);if(!a.error){this.queue.push(a)}else{this.errorQueue.push(a)}b++}while(b<e);this.loadedAll();this.updateScope()},updateScope:function(){this.root.$$phase||this.root.$digest()},bind:function(a,b){this.scope.$on(this.timestamp+":"+a,b.bind(this))},trigger:function(b,a){arguments[0]=this.timestamp+":"+b;this.scope.$broadcast.apply(this.scope,arguments)},loadedAll:function(){var a=this.queue.length;var b=function(c){c=c||0;if(c<a){if(!this.queue[c].isUploaded){switch(this.queue[c].transport){case"html5":this.xhrUplode(this.queue[c],function(){c++;b(c)});break;case"iframe":this.iframeUplode(this.queue[c]);break}}else{c++;b(c)}}}.bind(this);b()},xhrUplode:function(c,a){var b=new XMLHttpRequest(),d=new FormData(),e=this;c.xhr=b;e.trigger("beforeUplode",c,this);d.append("Filedata",c.file);if(this.post_params){angular.forEach(this.post_params,function(f,g){d.append(g,f)})}b.upload.onprogress=function(f){var g=f.lengthComputable?f.loaded*100/f.total:0;c.progress=g;e.updateScope()};b.onload=function(){if(this.readyState===4&&this.status===200){c.afterUploade(this.response);a()}};b.onabort=function(){};b.onerror=function(){c.error=k[110];e.errorQueue.push(c)};b.open("POST",this.url,true);b.send(d)},iframeUplode:function(b){var e=angular.element(b.file.input),a=n(e.clone())(this.scope),d=angular.element('<iframe name="iframeTransport'+Date.now()+'">'),c=angular.element('<form style="display: none;" />');c.prop({enctype:"multipart/form-data",target:d.prop("name"),action:this.url,method:"POST"});a.prop("value",null);e.prop("name","Filedata");e.css("display","none").after(a).after(c);c.append(e).append(d);if(this.post_params){angular.forEach(this.post_params,function(f,g){c.append(angular.element("<input type='hidden' name='"+g+"' value='"+f+"'>"))})}c[0].submit();angular.element(d).bind("load",function(){b.afterUploade(this.response);c.replaceWith("")})},SWFinit:function(b){var c=this;if(SWFUpload){var a=this.swfUploadOptions.button_placeholder_id||"flash";angular.extend(this.swfUploadOptions,{file_upload_limit:this.file_upload_limit,upload_url:this.url,post_params:this.post_params});var e=angular.extend([],c.acceptTypes),d=e.length;while(d--){e[d]="*."+e[d]+";*."+e[d].toUpperCase()}this.swfUploadOptions.file_types=e.join(";");b.after(angular.element('<div id="'+a+'"></div>'));this.swfUploadOptions.file_queued_handler=function(f){f.transport="flash";c.addFilesToQueue(f)};this.swfUploadOptions.upload_success_handler=function(f,g){angular.forEach(c.queue,function(h){if(h.file.flash.index===f.index){h.afterUploade(g)}})};this.swfUploadOptions.file_queue_error_handler=function(h,f,g){c.scope.$apply(function(){switch(f){case -100:c.errors.push(k[120]);break}})};this.swfUploadOptions.file_dialog_complete_handler=function(g,f){this.startUpload()};this.flash=new SWFUpload(this.swfUploadOptions)}}};var p=function(b,d,c){switch(c){case"iframe":var a=b.value,e=a.slice(a.lastIndexOf("\\")+1),c=a.slice(a.lastIndexOf(".")+1).toLowerCase();d.file={lastModifiedDate:new Date(),name:e,size:0,type:"image/"+c,input:b};d.transport="iframe";break;case"flash":d.file={lastModifiedDate:b.modificationdate,name:b.name,size:b.size,type:"image/"+b.type.slice(b.type.lastIndexOf(".")+1).toLowerCase(),flash:b};d.transport="flash";break}var c=d.file.type.slice(d.file.type.lastIndexOf("/")+1);if(d.uplode.acceptTypes.indexOf(c)===-1||!c){d.error=k[100]}angular.extend(this,{unicid:d.uplode.generateQuickGuid(),transport:"html5",isUploaded:false,error:false,mbSize:(d.file.size/(1000*1024)).toFixed(2),progress:0},d);return this};p.prototype={afterUploade:function(a){this.isUploaded=true;this.scope.result.allUploded++;this.uplode.trigger("uplodeItemComplite",this,a);this.uplode.updateScope()},remove:function(){var a=this.uplode.queue.indexOf(this);this.uplode.queue.splice(a,1);this.uplode.trigger("uplodeItemRemove",this);this.scope.result.allUploded--}};return{create:function(a){return l(a)},getInstance:function(c,d,a){var b=m(function(){var e=c[d];if(e){m.cancel(b);a(e)}},100)}}}]);